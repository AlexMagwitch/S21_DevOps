# Part 1. Инструмент ipcalc

## 1.1. Сети и маски
1. Адрес сети 192.167.38.54/13

    ![192.167.38.54/13](images/Part1-1-1-1.png)
    

2.  
    1. Перевод маски 255.255.255.0 в префискную и двоичную запись
        - CIDR: /24
        - Mask: 255.255.255.0
        - Binary mask: 11111111.11111111.11111111.00000000
        
        ![192.167.38.54/24](images/Part1-1-2-1.png)
 
    2. Перевод маски /15 в обычную и двоичную запись
        - CIDR: /15
        - Mask: 255.254.0.0
        - Binary mask: 11111111.11111110.00000000.00000000

        ![192.167.38.54/15](images/Part1-1-2-2.png)

    3. Перевод маски 11111111.11111111.11111111.11110000 в обычную и двоичную запись
        - CIDR: /28
        - Mask: 255.255.255.240
        - Binary mask: 11111111.11111111.11111111.11110000
        
        ![192.167.38.54/28](images/Part1-1-2-3.png)

3.  
    1. /8 

        ![12.167.38.4/8](images/Part1-1-3-1.png)
    2. 11111111.11111111.00000000.00000000

        ![12.167.38.4/16](images/Part1-1-3-2.png)
    3. 255.255.254.0

        ![12.167.38.4/23](images/Part1-1-3-3.png)
    4. /4

        ![12.167.38.4/4](images/Part1-1-3-4.png)

## 1.2. localhost
127.0.0.1 принадлежит диапазону loopback (или петлевой интерфейс), который зарезервирован для связи с самим устройством.
Все IP-адреса в диапазоне 127.0.0.0/8 (то есть от 127.0.0.0 до 127.255.255.255) также считаются петлевыми и могут использоваться для связи с localhost.

Можно обратиться к приложению с IP: 127.0.0.2/24, 127.1.0.1/8

Нельзя обратиться к приложению с IP: 194.34.23.100, 128.0.0.1

## 1.3 Диапазоны и сегменты сетей
1. Частные IP-адреса определены в следующих диапазонах:

    - 10.0.0.0 - 10.255.255.255
    - 172.16.0.0 – 172.31.255.255
    - 192.168.0.0 – 192.168.255.255

    Частные:

	- 10.0.0.45
	- 192.168.4.2
	- 172.20.250.4
	- 172.16.255.255
	- 10.10.10.10
	
	Публичные:

	- 134.43.0.2
	- 172.0.2.1
	- 192.172.0.1
	- 172.68.0.2
	- 192.169.168.1

2. Сеть 10.10.0.0/18 охватывает диапазон адресов от 10.10.0.0 до 10.10.63.255.

    Возможные адреса:

    - 10.10.0.2
    - 10.10.10.10
    - 10.10.1.255

    Невозможные адреса:

    - 10.0.0.1
    - 10.10.100.1

# Part 2. Статическая маршрутизация между двумя машинами
Смотрим существующие сетевые интерфейсы с помощью команды ip a:

![ip_a](images/Part2-0-1.png)

Вывод содержания измененного файла etc/netplan/00-installer-config.yaml для каждой машины и вызов команды netplan apply для перезапуска сервиса сети:

![netplan_config](images/Part2-0-2.png)

## 2.1. Добавление статического маршрута вручную
Добавим статистический маршрут при помощи команды ip r add и пропингуем соединение между машинами:

![ip_r_add](images/Part2-1-1.png)

## 2.2. Добавление статического маршрута с сохранением
Добавим статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml, перезапустим сервер сети и пропингуем соединение между машинами:

![static_route_config](images/Part2-2-1.png) 

# Part 3. Утилита iperf3
Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps:

- 8 Mbps = 1 MB/s
- 100 MB/s = 819200 Kbps
- 1 Gbps = 1024 Mbps

Утилита iperf3

![iperf](images/Part3.png)

# Part 4. Сетевой экран

## 4.1 Утилита iptables
Содержание файла /etc/firewall для каждой машины:

![cat /etc/firewall.sh](images/Part4-1.png)

Запускаем файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh:

![firewall.sh](images/Part4-2.png)

Разница в стратегиях заключается в том, что изначально в машине ws-1 мы сначала разрешаем, а после запрещаем вывод ping'a. В машине ws2 всё ровным счетом наоборот.

## 4.2. Утилита nmap
Видно, что хост второй машины запущен, но не пингуется.

![nmap](images/Part4-3.png)

# Part 5. Статическая маршрутизация сети

## 5.1. Настройка адресов машин

Содержание файла etc/netplan/00-installer-config.yaml для каждой машины и перезапуск сервиса сети:

![netplan](images/Part5-1.png)

Проверка адресов машин r1 и r2:

![check_ip_r1_r2](images/Part5-2.png)

Проверка адресов машин ws21 и ws22:

![check_ip_ws21_22](images/Part5-3.png)

Проверка адреса машины ws11:

![check_ip_ws11](images/Part5-4.png)

Пропингуем ws22 с ws21 и r1 с ws11:

![ping](images/Part5-5.png)

## 5.2. Включение переадресации IP-адресов

Включение переадресации IP на роутерах:

![ip_forward](images/Part5-6.png)

Файл /etc/sysctl.conf с добавленной строкой net.ipv4.ip_forward = 1:

![sysctl_conf](images/Part5-7.png)

## 5.3. Установка маршрута по умолчанию

Добавим gateway4 в файлы конфигураций рабочих станций, перезапустим сервис сети и вызовем команду ip r:

![default_route_1](images/Part5-8.png)

![default_route_2](images/Part5-9.png)

Пропингуем с ws11 роутер r2 и покажем на r2, что пинг доходит с помощью команды tcpdump -tn -i eth1:

![ping_tcpdump](images/Part5-10.png)

## 5.4. Добавление статических маршрутов

Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций, перезапустим сервис сети и вызовем команду ip r:

![static_routes_r1](images/Part5-11.png)

Вызов команд ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0 на ws11:

![ip_r_list_ws11](images/Part5-12.png)

Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, поскольку он является адресом сети и доступен без шлюза.

## 5.5. Построение списка маршрутизаторов

Запуск на r1 команды дампа tcpdump -tnv -i ent0 и построение списка маршрутизаторов на пути от ws11 до ws21 при помощи утилиты traceroute:

![dump_traceroute](images/Part5-13.png)

Принцип работы утилиты traceroute основан на последовательном определении маршрута, по которому данные проходят от вашего компьютера до указанного хоста в сети. Это достигается путём отправки серии сетевых пакетов с постепенным увеличением параметра TTL (Time To Live).

1. Отправка пакетов с начальным TTL:

    Traceroute отправляет первый пакет с TTL, равным 1.
    TTL указывает, сколько маршрутизаторов пакет может пройти перед истечением срока жизни. Каждый маршрутизатор на пути уменьшает TTL на 1.

2. Прерывание на первом маршрутизаторе:

    Когда TTL достигает 0, маршрутизатор, через который проходит пакет, отправляет обратно ICMP-сообщение типа "Time Exceeded" (время истекло).
    Traceroute фиксирует IP-адрес маршрутизатора, время отклика и продолжает.

3. Увеличение TTL и движение дальше:

    Traceroute увеличивает TTL на 1 (теперь он равен 2) и отправляет новый пакет.
    Пакет проходит первый маршрутизатор, затем второй, где TTL снова достигает 0, и снова возвращается ICMP-ответ от второго маршрутизатора.

4. Повторение процесса:

    Этот процесс повторяется, пока пакет не достигнет целевого хоста, который отвечает либо ICMP Echo Reply (в случае ICMP), либо другим типом пакетов (например, TCP или UDP).

## 5.6. Использование протокола **ICMP** при маршрутизации

Запуск на r1 перехвата сетевого трафика, проходящего через eth0 с помощью команды tcpdump -n -i eth0 icmp и пинг с ws11 несуществующего IP ping -c 1 10.30.0.111:
![imcp](images/Part5-14.png)

# Part 6. Динамическая настройка IP с помощью DHCP

1. Содержание файла /etc/dhcp/dhcpd.conf для r2 с конфигурацией службы DHCP:

![dhcp_config_r2](images/Part6-1.png)

Содержание файла resolv.conf с nameserver 8.8.8.8.:

![resolv_conf_r2](images/Part6-2.png)

2. Перезагрузка службы DHCP командой systemctl restart isc-dhcp-server:

![dhcp_restart_r2](images/Part6-3.png)

Перезагружаем машину ws21 при помощи reboot и через ip a покажем, что она получила адрес:

![ip_a_ws21](images/Part6-4.png)

Пинг ws22 с ws21:

![ping_ws21_ws22](images/Part6-5.png)

3. Cодержание файла etc/netplan/00-installer-config.yaml для ws11 с добавленным MAC адресом:

![netplan_config_ws11](images/Part6-6.png)

4. Аналогичная настройка r1 (с жесткой привязкой к MAC адресу)

DNS:

![resolv_conf_r1](images/Part6-7.png)

Конфигурация DHCP:

![dhcp_config_r1](images/Part6-8.png)

ip a на ws11:

![ws11](images/Part6-9.png)

5. Запрос обновления ip адреса с ws21

![ip_a_ws21_update](images/Part6-10.png)

Команда sudo dhclient -r enp0s3 освобождает текущий адрес интерфейса enp0s3.

Команда sudo dhclient enp0s3 задает новый адрес указанному интерфейсу.

# Part 7. NAT

1. Содержание файла /etc/apache2/ports.conf на ws22 и r2 (строка Listen 80 изменена на Listen 0.0.0.0:80):

![apache2_ports](images/Part7-1.png)

2. Запуск веб-сервера Apache командой service apache2 start на ws22 и r1:

![apache_start](images/Part7-2.png)

3. Добавление в фаервол на r2 следующих правил:

1) Удаление правил в таблице filter - iptables -F
2) Удаление правил в таблице "NAT" - iptables -F -t nat
3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

Добавление правил и запуск фаервола:

![firewall_r2](images/Part7-3.png)

Проверка соединения между ws22 и r1 командой ping:

![ping_r1_ws22](images/Part7-4.png)

4) Разрешим маршрутизацию всех пакетов протокола ICMP:

![firewall_r2_icmp](images/Part7-5.png)

Проверка соединения между ws22 и r1 командой ping:

![ping2_r1_ws22](images/Part7-6.png)

5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (сеть 10.20.0.0)

6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![SNAT_DNAT](images/Part7-7.png)

Проверка соединения по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой telnet [адрес] [порт]:

![telnet_ws22](images/Part7-8.png)

Проверка соединения по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet [адрес] [порт]:

![telnet_r1](images/Part7-9.png)


# Part 8. Дополнительно. Знакомство с SSH Tunnels

1. Запуск веб-сервера Apache на ws22 только на localhost:

![apache_start](images/Part8-1.png)

2. Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21:

Для Local TCP forwarding применяется команда ssh -L local_port:destination:destination_port ssh_server_ip

Проверка подключения:

![telnet_ws21](images/Part8-2.png)

3. Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11:

Для Remote TCP forwarding применяется команда ssh -R remote_port:destination:destination_port ssh_server_ip

Проверка подключения:

![telnet_ws11](images/Part8-3.png)

4. Доказательстов что что подключение сработало:

![telnet](images/Part8-4.png)